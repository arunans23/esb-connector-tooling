#set ( $ds = '$' )
#set ( $hash = '#' )
#set ( $ocb = '{' )
#set ( $ccb = '}' )
<?xml version="1.0" encoding="UTF-8"?>
<!--
 ~  Copyright (c) 2024, WSO2 LLC. (https://www.wso2.com) All Rights Reserved.
 ~
 ~  WSO2 LLC. licenses this file to you under the Apache License,
 ~  Version 2.0 (the "License"); you may not use this file except
 ~  in compliance with the License.
 ~  You may obtain a copy of the License at
 ~
 ~    http://www.apache.org/licenses/LICENSE-2.0
 ~
 ~  Unless required by applicable law or agreed to in writing,
 ~  software distributed under the License is distributed on an
 ~  "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 ~  KIND, either express or implied.  See the License for the
 ~  specific language governing permissions and limitations
 ~  under the License.
-->

<!-- Generated on $timestamp -->

<template xmlns="http://ws.apache.org/ns/synapse" name="$operation.getName()">
    #set($pathParameterList = "")
    #if ($operation.getPathParameters().size() > 0)
        <!-- Path Parameter List -->
        #foreach ($param in $operation.getPathParameters())
            <parameter name="$param.getParameterName()" #if ($param.getXmlDescription()) description="$param.getXmlDescription()" #end/>
            #set($pathParameterList = "$pathParameterList$param.getParameterName(),")
        #end
    #end
    #set($queryParameterList = "")
    #if ($operation.getQueryParameters().size() > 0)
        <!-- Query Parameter List -->
        #foreach ($param in $operation.getQueryParameters())
            <parameter name="$param.getParameterName()" #if ($param.getXmlDescription()) description="$param.getXmlDescription()" #end/>
            #set($queryParameterList = "$queryParameterList$param.getParameterName(),")
        #end
    #end
    #if ($operation.getHeaderParameters().size() > 0)
        <!-- Header Parameter List -->
        #foreach ($param in $operation.getHeaderParameters())
            <parameter name="$param.getParameterName()" #if ($param.getXmlDescription()) description="$param.getXmlDescription()" #end/>
        #end
    #end
    #if ($operation.getRequestParameters().size() > 0)
        <!-- Request Body Parameter List -->
        #foreach ($param in $operation.getRequestParameters())
            <parameter name="$param.getParameterName()" #if ($param.getXmlDescription()) description="$param.getXmlDescription()" #end/>
        #end
    #end
    #if ($operation.getCookieParameters().size() > 0)
        <!-- Cookie Parameter List -->
        #foreach ($param in $operation.getCookieParameters())
            <parameter name="$param.getParameterName()" #if ($param.getXmlDescription()) description="$param.getXmlDescription()" #end/>
        #end
    #end
    <parameter name="responseTarget" description="Indicates whether the response should be written to body or a property" />
    <paramater name="targetPropertyName" description="Name of the property to which the response should be written"/>
    <sequence>
        <class name="org.wso2.carbon.${connectorName}connector.RestURLBuilder">
            <property name="operationPath" value="$operation.getPath()"/>
            #if ($pathParameterList != "")
                <property name="pathParameters" value="$pathParameterList"/>
            #end
            #if ($queryParameterList != "")
            <property name="queryParameters" value="$queryParameterList"/>
            #end
        </class>
        #if ($contentType)
            #if ($operation.getRequestParameters().size() > 0)
                #if ($contentType == "application/json")
                    <payloadFactory media-type="json" template-type="freemarker">
                        <format>
                            <![CDATA[{
                            #set($count = 1)
                            #foreach ($parameter in $operation.getRequestParameters())
                                <${hash}if (args.arg${count})?has_content>
                                    "$parameter.getName()": "${ds}${ocb}args.arg${count}${ccb}"#if($velocityCount < $operation.getRequestParameters().size()),#end
                                </${hash}if>
                                #set($count = $count + 1)
                            #end
                            }]]>
                        </format>
                        <args>
                            #foreach ($parameter in $operation.getRequestParameters())
                                <arg evaluator="xml" expression="$func:$parameter.getParameterName()"/>
                            #end
                        </args>
                    </payloadFactory>
                #elseif ($contentType == "application/xml")
                    <payloadFactory media-type="xml" template-type="freemarker">
                        <format>
                            <![CDATA[<${root}>
                                #set($count = 1)
                                #foreach ($parameter in $operation.getRequestParameters())
                                    <${hash}if (args.arg${count})?has_content>
                                        <${parameter.getName()}>${ds}${ocb}args.arg${count}${ccb}</${parameter.getName()}>
                                    </${hash}if>
                                    #set($count = $count + 1)
                                #end
                            </${root}>]]>
                        </format>
                        <args>
                            #foreach ($parameter in $operation.getRequestParameters())
                                <arg evaluator="xml" expression="$func:$parameter.getParameterName()"/>
                            #end
                        </args>
                    </payloadFactory>
                #else
                    <payloadFactory media-type="xml" template-type="freemarker">
                        <format>
                            <![CDATA[<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/">
                                <soapenv:Header></soapenv:Header>
                                <soapenv:Body>
                                    <root>
                                        #set($count = 1)
                                        #foreach ($parameter in $operation.getRequestParameters())
                                            <${hash}if (args.arg${count})?has_content>
                                                <${parameter.getName()}>${ds}${ocb}args.arg${count}${ccb}</${parameter.getName()}>
                                            </${hash}if>
                                            #set($count = $count + 1)
                                        #end
                                    </root>
                                </soapenv:Body>
                            </soapenv:Envelope>]]>
                        </format>
                        <args>
                            #foreach ($parameter in $operation.getRequestParameters())
                                <arg evaluator="xml" expression="$func:$parameter.getParameterName()"/>
                            #end
                        </args>
                    </payloadFactory>
                #end
                <property name="DISABLE_CHUNKING" scope="axis2" type="STRING" value="true"/>
            #end
            <property name="messageType" value="$contentType" scope="axis2"/>
            <property name="ContentType" value="$contentType" scope="axis2"/>
        #end
        #if ($accept)
            <header name="Accept" value="$accept" scope="transport" action="set"/>
        #end
        #foreach ($param in $operation.getHeaderParameters())
            <property name="$param.getName()" value="$func:$param.getParameterName()" scope="transport" action="set"/>
        #end
        #foreach ($param in $operation.getCookieParameters())
            <property name="$param.getName()" value="$func:$param.getParameterName()" scope="transport"/>
        #end
        <switch source="$func:responseTarget">
            <case regex="body">
                <call>
                    <endpoint>
                        <http method="$httpMethod" uri-template="{uri.var.base}{+uri.var.urlPath}{+uri.var.urlQuery}"/>
                    </endpoint>
                </call>
            </case>
            <case regex="property">
                <call>
                    <endpoint>
                        <http method="$httpMethod" uri-template="{uri.var.base}{+uri.var.urlPath}{+uri.var.urlQuery}"/>
                    </endpoint>
                    <source type="body"/>
                    <target type="property">TARGET</target>
                </call>
            </case>
            <default>
                <property name="TARGET" expression="$func:concat('body:', 'json')" scope="default" type="STRING"/>
            </default>
        </switch>
    </sequence>
</template>
